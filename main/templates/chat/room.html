{% extends 'layouts/page.html'%}
{% load static %}

{% block content %}

  <link rel="stylesheet" href="{% static 'css/room.css'%}">
  <h2>{{ roomname }} ROOM </h2>
 
  <div id="main-chat-wrapper" class="main-chat-wrapper">
  </div>

  <div id="send-box">
      <input id="chat-message-input" type="text">
      <input id="chat-message-submit" type="button" value="Send">
  </div>

  <input id="room-name" type="hidden" value="{{roomname}}"/>

  <script>
      const roomName = document.getElementById('room-name').value;
      const mainChatWrapper = document.getElementById('main-chat-wrapper')
      function addMessage(message,user) {
          const messageContainer = document.createElement('div')
          const messageTitle = document.createElement('div')
          const messageBody = document.createElement('div')
          messageTitle.innerHTML = user
          messageBody.innerHTML = message
          messageContainer.appendChild(messageTitle)
          messageContainer.appendChild(messageBody)
          mainChatWrapper.appendChild(messageContainer)
          messageContainer.classList.add('message-container')
          messageTitle.classList.add('message-title')
          messageBody.classList.add('message-body')
      }

      const chatSocket = new WebSocket(
          'ws://'
          + window.location.host
          + '/ws/chat/'
          + roomName
          + '/'
      );

      chatSocket.onmessage = function(e) {
          const data = JSON.parse(e.data);
          //document.querySelector('#chat-log').value += (data.username+"::"+data.message + '\n');
          addMessage(data.message,data.username)
      };

      chatSocket.onclose = function(e) {
          console.error('Chat socket closed unexpectedly');
      };

      document.querySelector('#chat-message-input').focus();
      document.querySelector('#chat-message-input').onkeyup = function(e) {
          if (e.keyCode === 13) {  // enter, return
              document.querySelector('#chat-message-submit').click();
          }
      };

      document.querySelector('#chat-message-submit').onclick = function(e) {
          const messageInputDom = document.querySelector('#chat-message-input');
          const message = messageInputDom.value;
          chatSocket.send(JSON.stringify({
              'message': message,
              'username': "{{request.user.username}}"
          }));
          messageInputDom.value = '';
      };
  </script>
{% endblock %}
